# REST API

Проект организован в форме монорепозитория с использование инструмента <a alt="Nx logo" href="https://nx.dev" target="_blank" rel="noreferrer"><img src="https://raw.githubusercontent.com/nrwl/nx/master/images/nx-logo.png" width="45"></a> и построен
с помощью фреймворка **nest**.

В проекте содержатся следующие сервисы:
* **users**
* **notify**
* **goods**

### Список переменных окружения приложения:
Примеры переменных окружения содержатся в директории ./environments.

* RABBIT_USER=admin - логин подключения к rabbitmq
* RABBIT_PASSWORD=test - пароль подключения к rabbitmq
* RABBIT_HOST=localhost:5672 - адрес подключения к rabbitmq
* RABBIT_NOTIFY_SERVICE_SUBSCRIBERS_QUEUE=guitarshop.subscribers - очередь для записи в базу данных подписчика и отправки уведомления на почту пользовалелю о регистрации
* RABBIT_NOTIFY_SERVICE_ORDERS_QUEUE=guitarshop.orders - очередь для отправки уведомления администратору о сформированном заказе

* MONGO_DB=guitarshop-notify - наименование базы данных для хранения списка подписчиков почтовой рассылки
* MONGO_HOST=localhost - адрес подключения к базе данных
* MONGO_PORT=27018 - порт подключения к базе данных
* MONGO_USER=admin - имя пользователя подключающегося к базе данных
* MONGO_PASSWORD=test - пароль пользователя
* MONGO_AUTH_BASE=admin - имя базы данных, связанное с учетными данными пользователя

* MAIL_SMTP_HOST=localhost - адрес подключения к почтовому серверу
* MAIL_SMTP_PORT=5025 - порт подключения к почтовому серверу
* MAIL_USER_NAME=admin - имя подключения к почтовому серверу
* MAIL_USER_PASSWORD=test - пароль подключения к постовому серверу
* MAIL_FROM=<noreply@notify.local> - почта по умолчанию адресанта

### Запуск сервисов.

Сервисы монорепозитория располагаются по пути [./apps](./apps/).

Для удобства работы над проектом используются инструменты из **Node.js** и **npm**. Все необходимые настройки произведены. Убедитесь, что на рабочем компьютере установлен актуальный LTS релиз Node.js**. Затем, в терминале, перейдите в корневую директорию монорепозитория **/backend** и _единожды_ запустите команду:

```bash
npm install
```

Команда запустит процесс установки зависимостей проекта из **npm**.

После установки зависимостей проекта, в каждом **сервисе** имеется **docker-compose.yml** для запуска окружения неоходимого для работы каждого сервиса, запустите **docker daemon**. Перейдите в директорию сервиса, например **/backend/apps/users**

Далее выполниет команду:

```bash
docker-compose up -d
```
Данная команда загрузит необходимые образы из хранилища образов, создаст  соответствующие контейнеры.

Запускает конейнеры с базой данных и ее веб клиентом доступным на хосте и порте взависимости от значение переменных окружения.

После запуска соответствующего окружения база данных доступна для содинения с сервисом:

```bash
nx run users:serve
```

Команда собирает продакшен сервис в директорию **/backend/dist/<имя сервиса>** и запускает main.js файл рабочего сервиса.

---

Для работы сервиса **goods** используется ORM Prisma для удобной работы с базой данных PostgreSQl. После запуска окружения для работы сервиса через **docker** выполните команды, незабыв установить переменную оружения указанную в **.env.example** директории **/goods/prisma**.

```bash
nx run goods:db-migrate
```
Данная команда подключит prisma к **portgres** и сформирует таблицы данных на основании схемы **/prisma/schema.prisma**. 
Далее выполните команду 

```bash
nx run goods:db-generate
```

Команда сгенерирует prisma client в директории node_modules для архитектуры cpu по умолчанию, аппаратная часть которого выполняет данную команду, для генерации под различные архитектуры набора команд cpu используется поле **binaryTargets** генератора клиента **schema.prisma**.
После выполнения всего вышеуказанного можно запускать сервис.

```bash
npm run ts /apps/cli/main.ts -- --generate 10 http://localhost:3333/api/auth/register
```

Команда скомпилирует файл main.ts и запустит его, код выполнит подключение к postgres с помощью prisma client и заполнит базу моковыми данными, после произойдет подключение к сервису users через http запрос и создаст пользователя admin если он еще не создан.
Схема команды:
  --generate - команда для запуска скрипта заполнения данными
  10 - количетво создаваемых записей в базу
  http://localhost:3333/api/auth/register - ресурс регистрации пользователей

---

### Сценарии

Все сценарии работы с **NX** приведены в файле **project.json** в поле target соответствующего сервиса, запуск осуществляется командой
```bash
nx run <имя сервиса>:<сценарий поля target>
```
